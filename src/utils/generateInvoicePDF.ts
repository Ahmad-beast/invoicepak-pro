import jsPDF from 'jspdf';
import { Invoice, InvoiceItem } from '@/types/invoice';
import { format } from 'date-fns';

// --- CONSTANTS & CONFIGURATION ---
const PAGE_FORMAT = 'a4';
const UNIT = 'mm';
const MARGIN = 15;
const COLORS = {
  primary: [249, 115, 22] as [number, number, number], // Orange #F97316
  secondary: [15, 23, 42] as [number, number, number], // Dark Slate #0F172A
  accent: [241, 245, 249] as [number, number, number], // Light Gray #F1F5F9
  text: [51, 65, 85] as [number, number, number],      // Slate 700
  lightText: [100, 116, 139] as [number, number, number], // Slate 500
  white: [255, 255, 255] as [number, number, number],
  border: [226, 232, 240] as [number, number, number], // Border Gray
};

export const generateInvoicePDF = (invoice: Invoice, removeBranding: boolean = false): void => {
  // Initialize PDF
  const doc = new jsPDF({
    orientation: 'portrait',
    unit: UNIT,
    format: PAGE_FORMAT,
  });

  // Page Dimensions
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const contentWidth = pageWidth - MARGIN * 2;
  const rightColX = pageWidth - MARGIN;

  // State Tracking for Layout
  let y = MARGIN;
  let pageNumber = 1;

  // --- HELPER FUNCTIONS ---

  // 1. Text Helper with Auto-Wrapping
  const addText = (
    text: string | number,
    x: number,
    yPos: number,
    options: {
      size?: number;
      color?: [number, number, number];
      weight?: 'normal' | 'bold';
      align?: 'left' | 'center' | 'right';
      maxWidth?: number; // For wrapping
    } = {}
  ): number => {
    const { size = 9, color = COLORS.secondary, weight = 'normal', align = 'left', maxWidth } = options;
    
    doc.setFontSize(size);
    doc.setTextColor(...color);
    doc.setFont('helvetica', weight);

    // Handle Text Wrapping
    if (maxWidth) {
      const textLines = doc.splitTextToSize(String(text), maxWidth);
      doc.text(textLines, x, yPos, { align });
      // Return the height utilized by the text
      return textLines.length * (size * 0.3527) + 2; // Approximate height in mm
    } else {
      doc.text(String(text), x, yPos, { align });
      return 0;
    }
  };

  // 2. Formatting Helper
  const formatMoney = (amount: number, currency: string) => {
    return new Intl.NumberFormat('en-PK', {
      style: 'currency',
      currency: currency,
      minimumFractionDigits: 0,
      maximumFractionDigits: 2,
    }).format(amount);
  };

  // 3. Page Break Checker
  const checkPageBreak = (requiredSpace: number) => {
    // Footer Height ~ 20mm
    if (y + requiredSpace > pageHeight - 20) {
      addFooter(); // Add footer to current page
      doc.addPage();
      pageNumber++;
      y = MARGIN; // Reset Y
      return true;
    }
    return false;
  };

  // 4. Footer Generator (Calls on every page)
  const addFooter = () => {
    const footerY = pageHeight - 12;
    
    // Line
    doc.setDrawColor(...COLORS.border);
    doc.setLineWidth(0.5);
    doc.line(MARGIN, footerY - 5, pageWidth - MARGIN, footerY - 5);

    // Page Number
    addText(`Page ${pageNumber}`, pageWidth / 2, footerY, { size: 8, color: COLORS.lightText, align: 'center' });

    // Branding (if enabled)
    if (!removeBranding) {
      addText('Generated by InvoicePK', pageWidth - MARGIN, footerY, { size: 7, color: COLORS.lightText, align: 'right' });
    }
  };

  // --- START DRAWING INVOICE ---

  // === 1. HEADER SECTION ===
  // Logo / Brand Area
  if (!removeBranding) {
    addText('InvoicePK', MARGIN, y + 6, { size: 20, weight: 'bold', color: COLORS.primary });
    addText('Professional Invoice Management', MARGIN, y + 11, { size: 8, color: COLORS.lightText });
  } else {
    // Fallback if branding removed
    addText(invoice.senderName, MARGIN, y + 6, { size: 18, weight: 'bold', color: COLORS.secondary });
  }

  // Invoice Title & ID
  addText('INVOICE', rightColX, y + 6, { size: 24, weight: 'bold', color: COLORS.secondary, align: 'right' });
  addText(`# ${invoice.invoiceNumber}`, rightColX, y + 13, { size: 10, weight: 'bold', color: COLORS.text, align: 'right' });

  y += 25;

  // Separator Line
  doc.setDrawColor(...COLORS.primary);
  doc.setLineWidth(0.8);
  doc.line(MARGIN, y, pageWidth - MARGIN, y);
  y += 10;

  // === 2. ADDRESS & DATES SECTION ===
  const col1 = MARGIN;
  const col2 = MARGIN + 65;
  const col3 = pageWidth - MARGIN - 45;

  // FROM Section
  addText('FROM:', col1, y, { size: 8, weight: 'bold', color: COLORS.lightText });
  y += 5;
  addText(invoice.senderName || 'Sender Name', col1, y, { size: 10, weight: 'bold' });
  // Add email if available in future
  // y += 5; addText(invoice.senderEmail, col1, y, { size: 9, color: COLORS.lightText });
  
  // Reset Y for next column
  let maxY = y; 
  y -= 5; // Go back up

  // BILL TO Section
  addText('BILL TO:', col2, y, { size: 8, weight: 'bold', color: COLORS.lightText });
  y += 5;
  addText(invoice.clientName, col2, y, { size: 10, weight: 'bold' });
  
  y = Math.max(maxY, y); // Sync Y
  y -= 5; // Reset for Date Column

  // DATES Section (Right Side Box)
  // Background Box
  doc.setFillColor(...COLORS.accent);
  doc.roundedRect(col3 - 5, y - 5, 50 + MARGIN, 28, 2, 2, 'F');

  // Status
  addText('Status:', col3, y, { size: 9 });
  const statusColor = invoice.status === 'paid' ? [34, 197, 94] : [59, 130, 246]; // Green or Blue
  addText(invoice.status.toUpperCase(), rightColX, y, { size: 9, weight: 'bold', color: statusColor as any, align: 'right' });
  
  y += 7;
  addText('Invoice Date:', col3, y, { size: 9 });
  addText(format(new Date(invoice.invoiceDate), 'dd MMM yyyy'), rightColX, y, { size: 9, weight: 'bold', align: 'right' });

  y += 7;
  addText('Due Date:', col3, y, { size: 9 });
  addText(format(new Date(invoice.dueDate), 'dd MMM yyyy'), rightColX, y, { size: 9, weight: 'bold', align: 'right' });

  y += 20; // Move down after header section

  // === 3. PROJECT SUMMARY ===
  checkPageBreak(30);
  addText('PROJECT / SERVICE', MARGIN, y, { size: 8, weight: 'bold', color: COLORS.lightText });
  y += 5;
  
  // Dynamic Description Text
  doc.setFontSize(10);
  doc.setTextColor(...COLORS.text);
  const descLines = doc.splitTextToSize(invoice.serviceDescription, contentWidth);
  doc.text(descLines, MARGIN, y);
  
  y += (descLines.length * 5) + 8; // Adjust spacing based on text length

  // === 4. ITEMS TABLE ===
  const hasItems = invoice.items && invoice.items.length > 0;
  
  if (hasItems) {
    // Table Header Drawing Function
    const drawTableHeader = (currentY: number) => {
      doc.setFillColor(...COLORS.secondary);
      doc.rect(MARGIN, currentY, contentWidth, 8, 'F');
      
      const qtyX = pageWidth - MARGIN - 50;
      const rateX = pageWidth - MARGIN - 30;
      const amountX = pageWidth - MARGIN - 3;

      addText('DESCRIPTION', MARGIN + 3, currentY + 5.5, { size: 8, weight: 'bold', color: COLORS.white });
      addText('QTY', qtyX, currentY + 5.5, { size: 8, weight: 'bold', color: COLORS.white, align: 'right' });
      addText('RATE', rateX, currentY + 5.5, { size: 8, weight: 'bold', color: COLORS.white, align: 'right' });
      addText('AMOUNT', amountX, currentY + 5.5, { size: 8, weight: 'bold', color: COLORS.white, align: 'right' });
      
      return 8; // Header height
    };

    // Check space for header + at least 1 item
    if (checkPageBreak(25)) {
      y += drawTableHeader(y); // Draw on new page
    } else {
      y += drawTableHeader(y); // Draw on current page
    }

    y += 2; // Spacing

    // Loop Items
    invoice.items!.forEach((item, index) => {
      const qtyX = pageWidth - MARGIN - 50;
      const rateX = pageWidth - MARGIN - 30;
      const amountX = pageWidth - MARGIN - 3;
      
      // Calculate Height needed for this row
      // We wrap the description to calculate height
      const descWidth = contentWidth - 65; // Available width for text
      const descLines = doc.splitTextToSize(item.description, descWidth);
      const rowHeight = Math.max(10, descLines.length * 5 + 4);

      // Check for Page Break
      if (checkPageBreak(rowHeight)) {
        // If page break, redraw header
        y += drawTableHeader(y);
        y += 2;
      }

      // Zebra Striping (Optional, looks nice)
      if (index % 2 !== 0) {
        doc.setFillColor(...COLORS.accent);
        doc.rect(MARGIN, y, contentWidth, rowHeight, 'F');
      }

      // Draw Row Content
      doc.setTextColor(...COLORS.text);
      doc.setFontSize(9);
      doc.text(descLines, MARGIN + 3, y + 4); // Wrapped Description
      
      addText(item.quantity.toString(), qtyX, y + 4, { size: 9, align: 'right' });
      addText(formatMoney(item.rate, invoice.currency), rateX, y + 4, { size: 9, align: 'right' });
      addText(formatMoney(item.amount, invoice.currency), amountX, y + 4, { size: 9, weight: 'bold', align: 'right' });

      y += rowHeight;
      
      // Draw Divider Line
      doc.setDrawColor(...COLORS.border);
      doc.setLineWidth(0.2);
      doc.line(MARGIN, y, pageWidth - MARGIN, y);
    });
  }

  y += 5; // Spacing after table

  // === 5. TOTALS & NOTES SECTION ===
  // Calculate Totals
  const totalAmount = hasItems 
    ? invoice.items!.reduce((sum, item) => sum + item.amount, 0) 
    : invoice.amount;
  
  const convertedAmount = invoice.currency === 'USD' 
    ? totalAmount * invoice.conversionRate 
    : totalAmount / invoice.conversionRate;
  const convertedCurrency = invoice.currency === 'USD' ? 'PKR' : 'USD';

  // Check Page Break for Bottom Section
  // We need about 60mm for totals + notes
  checkPageBreak(60);

  const notesWidth = contentWidth * 0.55;
  const totalsWidth = contentWidth * 0.40;
  const totalsX = pageWidth - MARGIN - totalsWidth;

  // -- LEFT SIDE: NOTES --
  const notesStartY = y;
  if (invoice.notes) {
    addText('NOTES & TERMS', MARGIN, y + 5, { size: 8, weight: 'bold', color: COLORS.lightText });
    y += 10;
    
    doc.setFontSize(8);
    doc.setTextColor(...COLORS.lightText);
    const noteLines = doc.splitTextToSize(invoice.notes, notesWidth);
    doc.text(noteLines, MARGIN, y);
  }

  // -- RIGHT SIDE: TOTALS --
  // Reset Y to start of section for Totals column
  let totalsY = notesStartY;
  
  // Background for Totals
  doc.setFillColor(...COLORS.accent);
  doc.roundedRect(totalsX, totalsY, totalsWidth, 45, 2, 2, 'F');
  
  totalsY += 8;
  const labelX = totalsX + 5;
  const valueX = pageWidth - MARGIN - 5;

  // Subtotal
  addText(`Subtotal (${invoice.currency})`, labelX, totalsY, { size: 9, color: COLORS.lightText });
  addText(formatMoney(totalAmount, invoice.currency), valueX, totalsY, { size: 9, weight: 'bold', align: 'right' });
  
  totalsY += 8;
  
  // Exchange Rate (only if relevant)
  addText('Exchange Rate', labelX, totalsY, { size: 9, color: COLORS.lightText });
  addText(`1 USD = ${invoice.conversionRate} PKR`, valueX, totalsY, { size: 9, align: 'right' });
  
  totalsY += 8;

  // Divider inside totals box
  doc.setDrawColor(...COLORS.border);
  doc.line(totalsX + 5, totalsY, pageWidth - MARGIN - 5, totalsY);
  totalsY += 8;

  // Grand Total
  addText(`TOTAL (${convertedCurrency})`, labelX, totalsY + 2, { size: 10, weight: 'bold', color: COLORS.primary });
  addText(formatMoney(convertedAmount, convertedCurrency), valueX, totalsY + 2, { size: 12, weight: 'bold', color: COLORS.primary, align: 'right' });

  // === 6. FINALIZE ===
  addFooter(); // Add footer to the last page
  doc.save(`${invoice.invoiceNumber || 'invoice'}.pdf`);
};
